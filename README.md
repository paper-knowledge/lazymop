# Efficient Explicit-Trace Runtime Verification for Software Testing

## Appendix
See [appendix.pdf](appendix.pdf) for the formative study and evolution experiment results.

## Projects and data
You can find the 61 projects and their revision (for RQ1 and RQ2) that we evaluate [here](data/projects.csv). [This file](data/imm-study.csv) contains the
IMMs statistics for these 61 projects, and [this directory](data/evolution) contains the raw data from the software evolution experiments.

## Repository structure
| Directory               | Purpose                                       |
| ------------------------| --------------------------------------------- |
| Docker                  | scripts to run our experiments in Docker      |
| data                    | raw data (see section above)                  |
| extensions              | a Maven extension to run LazyMOP              |
| mop                     | the set of JavaMOP specifications that we use |
| experiments             | LazyMOP and our experimental infrastructure   |
| agents                  | JavaMOP's and TraceMOP's Java agent           |
| imm-plugin              | a Maven plugin for LazyMOP^e                  |
| monitoring-engine       | LazyMOP's monitroing infrastructure           |
| sha                     | SHAs for evolution experiments                |
| spec-parser             | LazyMOP's algorithm generation infrastructure |
| props                   | 84 JavaMOP's FSM specs that LazyMOP supports  |


## Usage
### Prerequisites:
- A x86-64 architecture machine
- Ubuntu 22.04
- [Docker](https://docs.docker.com/get-docker/)
### Setup
First, you need to build a Docker image. Run the following commands in the terminal.
```sh
docker build -f Docker/Dockerfile . --tag=lazymop:latest
docker run -it --rm lazymop:latest
./setup.sh  # run this command in Docker container
```
Then, run the following command in a new terminal window.
```sh
docker ps  # get container id
docker commit <container-id> lazymop:latest
# You can now close the previous terminal window by entering `exit`
```

Notes: We also use Singularity in our experiments. However, the usage of Singularity varies depending on the machine, so this README will focus on how to run our experiments using Docker. We convert the Docker image to a Singularity image using the `singularity pull docker://org/repo` command.

### Run single revision experiments (RQ1/RQ2)
```sh
# Enter the following commands outside the Docker container and inside the current repository directory
cd Docker

# If you want to run single version experiment on all projects (this could take multiple days), then run the below command. If you only want to run experiment on one project (almson/almson-refcount), then skip the command below.
cp projects-all.csv projects.csv

# Run experiment: (JavaMOP, TraceMOP, LazyMOP) for one program version
bash experiment_in_docker.sh projects.csv output
```
#### Output
The above commands will generate an `output` directory. The `output` directory contains one sub-directory per project.
The `output/<project-name>/output/tinymop-logs` directory contains logs from multiple runs. It contains
the following important files/directories:
- `test.log`: test (without RV) log
- `mop.log`: JavaMOP's log
- `track.log`: TraceMOP's log
- `gen.log`: LazyMOP's log
- `all-traces-*`: Traces generated by TraceMOP
- `tinymop-traces/*`: Traces generated by LazyMOP

### Run evolution related experiments (RQ3/RQ4)
```sh
# Enter the following commands outside the Docker container and inside the current repository directory
cd Docker

# If you want to run experiment on all projects (this cound take multiple days), then run the below command. If you only want to run experiment on one project (dakusui/jcunit), then skip the command below.
cp projects-evo-all.csv projects-evo.csv

# Run experiment (JavaMOP, LazyMOP, LazyMOP^e, ps1c, ps3cl, ps1c with LazyMOP^e, and ps3cl with LazyMOP^e)
bash imm_in_docker.sh projects-evo.csv evo-output ../sha
```

#### Output
The above commands will generate an `evo-output` directory. The `evo-output` directory contains one sub-directory per project.
The `output/<project-name>/output` directory contains logs from multiple runs. This directory contains a `report.csv` file
with the following header:
```
sha,download status,download time,test status,test time,mop status,mop time,gen status,gen time,imm status,imm time,gen+ps1c status,gen+ps1c time,gen+ps3cl status,gen+ps3cl time,mop+ps1c status,mop+ps1c time,mop+ps3cl status,mop+ps3cl time,imm+ps1c status,imm+ps1c time,imm+ps3cl status,imm+ps3cl time
```
- `mop` represents JavaMOP
- `gen` represents LazyMOP
- `imm` represents LazyMOP^e
- `mop+ps1c` represents eMOP's ps1c
- `mop+ps3cl` represents eMOP's ps3cl
- `imm+ps1c` represents combining LazyMOP^e with eMOP's ps1c
- `imm+ps3cl` represents combining LazyMOP^e with eMOP's ps3cl

## A full list of concurrency-related classes (and their subclasses) whose methods LazyMOP checks for
- `Thread`
- `ExecutorService`
- `ThreadPoolExecutor`
- `ForkJoinPool`
- `CompletableFuture`
- `Timer`

## Per spec de-instrumentation
For the following specs, LazyMOP^e will de-instrument the method for those specs if all events are signaled due to Java's for-each loop. It is safe to de-instrument the method because the JDK guarantees that the spec will never be violated.
- `Iterator_HasNext`
- `Iterator_RemoveOnce`
- `ListIterator_RemoveOnce`
- `ListIterator_Set`
- `ListIterator_hasNextPrevious`

For the following specs, LazyMOP^e will de-instrument for those specs if all events are signaled due to Java's for-each loop and no `modify*` events are observed during the run. It is safe to do so because the traces prove that the data structure is not modified while the iterator is being used.
- `ArrayDeque_UnsafeIterator`
- `Collection_UnsafeIterator`
- `Map_UnsafeIterator`
- `NavigableMap_UnsafeIterator`

## (Optional) Add LazyMOP's Java Agent to a Maven project
To run LazyMOP on Maven project, first build LazyMOP's Java agent, then add LazyMOP's Java agent to project's pom.xml file. Here is an example.
```bash
docker run -it --rm lazymop:latest  # Start a LazyMOP container
cd tinymop && bash make-jars.sh  # Build Java agent (in agents/gen.jar)
git clone https://github.com/JetBrains/jetCheck && cd jetCheck && git checkout 8a7b75581  # Clone JetBrains/jetCheck
```
Add the following code to `pom.xml`'s `<plugins>` block:

```xml
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-surefire-plugin</artifactId>
    <version>3.1.2</version>
    <configuration>
        <argLine>-javaagent:${HOME}/tinymop/agents/gen.jar</argLine>
    </configuration>
</plugin>
```

Then, run test with the follwoing commands:
```bash
export TINYMOP_TRACEDB_PATH=$(pwd)/lazymop-traces  # Set traces location
export COLLECT_TRACES=1
mkdir -p ${TINYMOP_TRACEDB_PATH}  # create traces directory
mvn test  # Run test, then you will find traces in the lazymop-traces directory
```
